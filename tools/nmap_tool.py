import nmap
from utils.tool_registry import register_tool
from utils.vulnerability_utils import merge_categorized_results

def nmap_scan(endpoint):
    nm = nmap.PortScanner()
    nm.scan(hosts=endpoint, arguments='-sV -sS -T4 -A', ports='1-65535', sudo=True)
    return nm

def categorize_nmap_results(results):
    final_categorized = {}; description = ''

    print(f"Result: {results}")

    for host in results.all_hosts():
        for proto in results[host].all_protocols():
            for port in results[host][proto].keys():
                service = results[host][proto][port]['name']
                cve_id = results[host][proto][port].get('cpe', None)

                print(f'CVD_ID: {cve_id}')

                if not (cve_id and isinstance(cve_id, str) and cve_id.strip()):
                    description = f"Open port {port}/{proto} running {service} on {host}"

                print(f"Final Categorized: {final_categorized}")

                merge_categorized_results(final_categorized, cve_id=cve_id, description=description)

    return final_categorized

# Register Nmap tool
register_tool('nmap', nmap_scan, categorize_nmap_results)
