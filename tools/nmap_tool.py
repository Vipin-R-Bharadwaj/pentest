import nmap
from tool_registry import register_tool
from utils.nvd_lookup import get_cvss_score

def nmap_scan(endpoint):
    nm = nmap.PortScanner()
    nm.scan(hosts=endpoint, arguments='-sV')
    return nm

def categorize_nmap_results(results, endpoint):
    categorized = {
        "critical": [],
        "high": [],
        "medium": [],
        "low": [],
        "info": []
    }

    for host in results.all_hosts():
        for proto in results[host].keys():
            for port in results[host][proto]:
                service = results[host][proto][port]['name']
                cve_id = results[host][proto][port].get('cpe', None)

                if cve_id:
                    cvss_score = get_cvss_score(cve_id)

                    if cvss_score:
                        if cvss_score >= 9.0:
                            categorized['critical'].append(f"Nmap found critical issue on {endpoint}: {cve_id}")
                        elif cvss_score >= 7.0:
                            categorized['high'].append(f"Nmap found high issue on {endpoint}: {cve_id}")
                        elif cvss_score >= 4.0:
                            categorized['medium'].append(f"Nmap found medium issue on {endpoint}: {cve_id}")
                        else:
                            categorized['low'].append(f"Nmap found low issue on {endpoint}: {cve_id}")
                else:
                    categorized['info'].append(f"Nmap found open port {port}/{proto} running {service} on {host}")

    return categorized

# Register the tool in the registry
register_tool('nmap', nmap_scan, categorize_nmap_results)
